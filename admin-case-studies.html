<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Case Studies | Vulaegis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .preview-card { border: 2px dashed #dee2e6; min-height: 200px; }
    .case-study-item { transition: all 0.3s ease; }
    .case-study-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .status-badge { font-size: 0.8rem; padding: 0.35rem 0.75rem; }
    .auto-loading { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
    .manual-update-section { background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">Vulaegis Admin - Direct Sheet Reader</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">View Site</a></li>
        <li class="nav-item"><a class="nav-link" href="case-studies.html">Case Studies</a></li>
        <li class="nav-item"><a class="nav-link active" href="admin-direct.html">Admin (Direct)</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-5">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Case Studies Admin - Direct Sheet Reader</h1>
      <p class="lead">Reads directly from published Google Sheet - No CORS issues!</p>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="alert alert-info">
    <h6><i class="bi bi-info-circle"></i> How This Works</h6>
    <p class="mb-0">This page reads your <strong>published Google Sheet CSV data</strong> directly. To add/update case studies, edit the Google Sheet manually using the link below.</p>
  </div>

  <!-- Auto-loading Status -->
  <div id="autoLoading" class="auto-loading mb-4">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 mb-0">Loading case studies directly from Google Sheets...</p>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-google"></i> Google Sheet Management</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
               class="btn btn-success" target="_blank">
              <i class="bi bi-pencil"></i> Edit Google Sheet Directly
            </a>
            <button class="btn btn-outline-primary" onclick="loadCaseStudies()">
              <i class="bi bi-arrow-clockwise"></i> Refresh Case Studies
            </button>
          </div>
          <div class="mt-3">
            <small class="text-muted">
              <strong>To add case studies:</strong><br>
              1. Click "Edit Google Sheet" above<br>
              2. Add new rows in the correct format<br>
              3. Click "Refresh Case Studies" to see updates
            </small>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> Statistics</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <div class="h4 mb-1 text-primary" id="totalStudies">0</div>
              <small class="text-muted">Total Studies</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-1 text-warning" id="ongoingStudies">0</div>
              <small class="text-muted">Ongoing</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-1 text-success" id="completedStudies">0</div>
              <small class="text-muted">Completed</small>
            </div>
          </div>
          <div class="mt-3">
            <small class="text-muted" id="lastUpdated">Last updated: Never</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Update Instructions -->
  <div class="manual-update-section">
    <h5><i class="bi bi-journal-text"></i> How to Manually Add Case Studies</h5>
    <div class="row">
      <div class="col-md-6">
        <h6>Step 1: Open Your Google Sheet</h6>
        <p>Click the "Edit Google Sheet Directly" button above to open your sheet.</p>
      </div>
      <div class="col-md-6">
        <h6>Step 2: Add New Row</h6>
        <p>Add a new row at the bottom with this format:</p>
        <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>ID</th><th>Title</th><th>Abstract</th><th>Status</th><th>DriveLink</th><th>DateAdded</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>CS-006</td><td>Your Title</td><td>Your Description</td><td>ongoing</td><td>PDF Link</td><td>2024-01-20</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Existing Case Studies -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-dark text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Current Case Studies</h5>
            <div>
              <span class="badge bg-primary me-2" id="studiesCount">0 studies</span>
              <button class="btn btn-sm btn-outline-light" onclick="loadCaseStudies()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="existingStudies">
            <!-- Case studies will be loaded here automatically -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Published Google Sheets CSV URL (No CORS issues!)
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQZEZswOKOUaXz2UzyJE2bKtavohwpqUbqaaXGa-YmDQAN79tgrA34d-MtxTT-JKNsVe28cJ1BQCfNY/pub?output=csv';

// Load case studies automatically when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadCaseStudies();
});

// Function to load case studies directly from published CSV
async function loadCaseStudies() {
  const container = document.getElementById('existingStudies');
  const autoLoading = document.getElementById('autoLoading');
  
  // Show loading state
  autoLoading.style.display = 'block';
  container.innerHTML = '';

  try {
    const response = await fetch(SHEET_CSV_URL);
    const csvText = await response.text();
    const caseStudies = parseCSV(csvText);
    
    displayCaseStudies(caseStudies);
    updateStatistics(caseStudies);
    document.getElementById('studiesCount').textContent = `${caseStudies.length} case studies`;
    document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
    
    // Hide auto-loading after successful load
    autoLoading.style.display = 'none';
    
  } catch (error) {
    console.error('Error loading case studies:', error);
    container.innerHTML = `
      <div class="col-12 text-center py-5">
        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
        <h4 class="mt-3">Connected Successfully!</h4>
        <p class="text-muted">But no case studies found in the sheet.</p>
        <div class="mt-3">
          <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
             class="btn btn-primary" target="_blank">
            <i class="bi bi-pencil"></i> Add Your First Case Study
          </a>
        </div>
      </div>
    `;
    autoLoading.style.display = 'none';
  }
}

// Function to parse CSV data
function parseCSV(csvText) {
  const lines = csvText.split('\n');
  const caseStudies = [];
  
  // Skip header row (index 0) and start from index 1
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Simple CSV parsing - handle quoted fields
    const columns = parseCSVLine(line);
    
    if (columns.length >= 5) {
      const caseStudy = {
        id: columns[0] || `row-${i}`,
        title: columns[1] || 'Untitled Project',
        abstract: columns[2] || 'No description available',
        status: columns[3] || 'completed',
        driveLink: columns[4] || '#',
        dateAdded: columns[5] || 'Unknown date'
      };
      
      // Only add if it has a title (not empty row)
      if (caseStudy.title && caseStudy.title !== 'Untitled Project') {
        caseStudies.push(caseStudy);
      }
    }
  }
  
  return caseStudies;
}

// Improved CSV line parser
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  // Add the last column
  result.push(current.trim());
  return result;
}

// Function to display case studies
function displayCaseStudies(caseStudies) {
  const container = document.getElementById('existingStudies');
  
  if (caseStudies.length === 0) {
    container.innerHTML = `
      <div class="col-12 text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
        <h4 class="mt-3">No Case Studies Found</h4>
        <p class="text-muted">Your Google Sheet is connected but no case studies found.</p>
        <div class="mt-3">
          <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
             class="btn btn-success" target="_blank">
            <i class="bi bi-plus-circle"></i> Add Case Studies to Sheet
          </a>
        </div>
        <div class="mt-3">
          <small class="text-muted">
            <strong>Sheet Format Required:</strong><br>
            Columns: ID, Title, Abstract, Status, DriveLink, DateAdded
          </small>
        </div>
      </div>
    `;
    return;
  }

  // Group by status
  const ongoing = caseStudies.filter(cs => cs.status === 'ongoing');
  const review = caseStudies.filter(cs => cs.status === 'review');
  const completed = caseStudies.filter(cs => cs.status === 'completed');

  let html = '';

  // Ongoing Studies
  if (ongoing.length > 0) {
    html += `
      <div class="mb-4">
        <h6 class="text-warning mb-3"><i class="bi bi-arrow-repeat"></i> Ongoing Projects (${ongoing.length})</h6>
        <div class="row g-3">
          ${ongoing.map(caseStudy => createCaseStudyCard(caseStudy)).join('')}
        </div>
      </div>
    `;
  }

  // Under Review Studies
  if (review.length > 0) {
    html += `
      <div class="mb-4">
        <h6 class="text-info mb-3"><i class="bi bi-clock"></i> Under Review (${review.length})</h6>
        <div class="row g-3">
          ${review.map(caseStudy => createCaseStudyCard(caseStudy)).join('')}
        </div>
      </div>
    `;
  }

  // Completed Studies
  if (completed.length > 0) {
    html += `
      <div class="mb-4">
        <h6 class="text-success mb-3"><i class="bi bi-check-circle"></i> Completed (${completed.length})</h6>
        <div class="row g-3">
          ${completed.map(caseStudy => createCaseStudyCard(caseStudy)).join('')}
        </div>
      </div>
    `;
  }

  container.innerHTML = html;
}

// Function to create individual case study card
function createCaseStudyCard(caseStudy) {
  const statusBadge = getStatusBadge(caseStudy.status);
  
  return `
    <div class="col-md-6 col-lg-4">
      <div class="case-study-item card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            ${statusBadge}
            <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
               class="btn btn-sm btn-outline-secondary" target="_blank" title="Edit in Sheet">
              <i class="bi bi-pencil"></i>
            </a>
          </div>
          <h6 class="card-title">${caseStudy.title}</h6>
          <p class="card-text small">${caseStudy.abstract}</p>
          <div class="d-flex justify-content-between align-items-center mt-auto">
            <small class="text-muted">${caseStudy.dateAdded}</small>
            <a href="${caseStudy.driveLink}" class="btn btn-primary btn-sm" target="_blank" title="View PDF">
              <i class="bi bi-file-pdf"></i> View PDF
            </a>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Function to get status badge HTML
function getStatusBadge(status) {
  const badges = {
    'ongoing': '<span class="badge bg-warning text-dark status-badge mb-2">Ongoing</span>',
    'review': '<span class="badge bg-info status-badge mb-2">Under Review</span>',
    'completed': '<span class="badge bg-success status-badge mb-2">Completed</span>'
  };
  return badges[status] || '<span class="badge bg-secondary status-badge mb-2">Unknown</span>';
}

// Function to update statistics
function updateStatistics(caseStudies) {
  const total = caseStudies.length;
  const ongoing = caseStudies.filter(cs => cs.status === 'ongoing').length;
  const completed = caseStudies.filter(cs => cs.status === 'completed').length;
  
  document.getElementById('totalStudies').textContent = total;
  document.getElementById('ongoingStudies').textContent = ongoing;
  document.getElementById('completedStudies').textContent = completed;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
