<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Case Studies | Vulaegis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .preview-card { border: 2px dashed #dee2e6; min-height: 200px; }
    .case-study-item { transition: all 0.3s ease; }
    .case-study-item:hover { background-color: #f8f9fa; }
    .loading { opacity: 0.6; pointer-events: none; }
    .status-badge { font-size: 0.8rem; padding: 0.35rem 0.75rem; }
    .config-section { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .success-alert { display: none; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">Vulaegis Admin</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">View Site</a></li>
        <li class="nav-item"><a class="nav-link" href="case-studies.html">Case Studies</a></li>
        <li class="nav-item"><a class="nav-link active" href="admin-case-studies.html">Admin</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-5">
  <!-- Success Alert -->
  <div id="successAlert" class="alert alert-success success-alert alert-dismissible fade show" role="alert">
    <span id="successMessage">Operation completed successfully!</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Case Studies Admin Panel</h1>
      <p class="lead">Manage your case studies directly in Google Sheets</p>
    </div>
  </div>

  <!-- Configuration Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="config-section">
        <h5><i class="bi bi-gear-fill"></i> Google Apps Script Configuration</h5>
        <div class="row">
          <div class="col-md-8">
            <label for="scriptUrl" class="form-label">Web App URL</label>
            <input type="url" class="form-control" id="scriptUrl" 
                   placeholder="https://script.google.com/macros/s/.../exec"
                   value="">
            <div class="form-text">Enter the URL from your deployed Google Apps Script web app</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
              <button type="button" class="btn btn-primary" onclick="testConnection()">
                <span id="testConnectionText">Test Connection</span>
                <span id="testConnectionSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
              </button>
            </div>
          </div>
        </div>
        <div id="connectionStatus" class="mt-2"></div>
        
        <!-- Quick Setup Guide -->
        <div class="mt-4">
          <h6>Quick Setup Guide:</h6>
          <ol class="small mb-0">
            <li>Create Google Apps Script at <a href="https://script.google.com" target="_blank">script.google.com</a></li>
            <li>Copy the provided code and deploy as web app</li>
            <li>Set "Execute as: Me" and "Who has access: Anyone"</li>
            <li>Paste the web app URL above and test connection</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Add New Case Study Form -->
    <div class="col-lg-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Case Study</h5>
        </div>
        <div class="card-body">
          <form id="caseStudyForm">
            <div class="mb-3">
              <label for="projectTitle" class="form-label">Project Title *</label>
              <input type="text" class="form-control" id="projectTitle" required
                     placeholder="Enter project title">
            </div>
            
            <div class="mb-3">
              <label for="projectAbstract" class="form-label">Abstract/Description *</label>
              <textarea class="form-control" id="projectAbstract" rows="4" required
                        placeholder="Describe the project, objectives, and key outcomes"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="projectStatus" class="form-label">Status *</label>
              <select class="form-select" id="projectStatus" required>
                <option value="">Select Status</option>
                <option value="ongoing">Ongoing</option>
                <option value="review">Under Review</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="googleDriveLink" class="form-label">Google Drive PDF Link *</label>
              <input type="url" class="form-control" id="googleDriveLink" 
                     placeholder="https://drive.google.com/file/d/.../view" required>
              <div class="form-text">
                <small>
                  • Make sure your PDF is shared with "Anyone with the link can view"<br>
                  • The link should end with <code>/view</code>
                </small>
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success" id="submitBtn">
                <i class="bi bi-cloud-upload"></i> Add Case Study to Google Sheets
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="previewCaseStudy()">
                <i class="bi bi-eye"></i> Preview
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Instructions -->
      <div class="card shadow mt-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Setup Instructions</h5>
        </div>
        <div class="card-body">
          <h6>Google Apps Script Setup:</h6>
          <ol class="small">
            <li>Go to <a href="https://script.google.com" target="_blank">script.google.com</a></li>
            <li>Create new project and paste this code:
              <pre class="bg-dark text-light p-2 mt-2 small"><code>function doGet(e) {
  return ContentService.createTextOutput(
    JSON.stringify({result: 'GET not supported'})
  ).setMimetype(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const sheetId = '1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c';
    const sheetName = 'Sheet1';
    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheetByName(sheetName);
    
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 6).setValues([
        ['ID','Title','Abstract','Status','DriveLink','DateAdded']
      ]);
    }
    
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    if (action === 'addCaseStudy') {
      const lastRow = sheet.getLastRow();
      const newRow = [
        Utilities.getUuid(),
        data.title,
        data.abstract,
        data.status,
        data.driveLink,
        new Date().toISOString()
      ];
      sheet.getRange(lastRow + 1, 1, 1, newRow.length).setValues([newRow]);
      return ContentService.createTextOutput(
        JSON.stringify({success: true, message: 'Case study added'})
      ).setMimetype(ContentService.MimeType.JSON);
    }
    
    if (action === 'getCaseStudies') {
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) {
        return ContentService.createTextOutput(
          JSON.stringify({success: true, data: []})
        ).setMimetype(ContentService.MimeType.JSON);
      }
      const caseStudies = [];
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (row[0]) {
          caseStudies.push({
            id: row[0], title: row[1], abstract: row[2],
            status: row[3], driveLink: row[4], dateAdded: row[5]
          });
        }
      }
      return ContentService.createTextOutput(
        JSON.stringify({success: true, data: caseStudies})
      ).setMimetype(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(
      JSON.stringify({success: false, error: 'Unknown action'})
    ).setMimetype(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(
      JSON.stringify({success: false, error: error.message})
    ).setMimetype(ContentService.MimeType.JSON);
  }
}</code></pre>
            </li>
            <li>Deploy as web app: Execute as "Me", Access "Anyone"</li>
            <li>Copy the web app URL and paste above</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="col-lg-6">
      <div class="card shadow">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h5>
        </div>
        <div class="card-body">
          <div id="previewArea" class="preview-card p-3 text-center text-muted">
            <i class="bi bi-card-text" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">Your case study preview will appear here</p>
            <small class="text-muted">Fill out the form and click "Preview"</small>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card shadow mt-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="loadCaseStudies()" id="refreshBtn">
              <i class="bi bi-arrow-clockwise"></i> Refresh Case Studies List
            </button>
            <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
               class="btn btn-outline-secondary" target="_blank" id="sheetLink">
              <i class="bi bi-google"></i> Open Google Sheet
            </a>
            <a href="https://script.google.com/home" 
               class="btn btn-outline-secondary" target="_blank">
              <i class="bi bi-code-slash"></i> Open Google Apps Script
            </a>
          </div>
        </div>
      </div>

      <!-- Connection Status -->
      <div class="card shadow mt-4">
        <div class="card-header bg-warning">
          <h5 class="mb-0"><i class="bi bi-wifi"></i> Connection Status</h5>
        </div>
        <div class="card-body">
          <div id="statusInfo">
            <div class="row text-center">
              <div class="col-4">
                <div class="h4 mb-1" id="totalStudies">0</div>
                <small class="text-muted">Total Studies</small>
              </div>
              <div class="col-4">
                <div class="h4 mb-1" id="ongoingStudies">0</div>
                <small class="text-muted">Ongoing</small>
              </div>
              <div class="col-4">
                <div class="h4 mb-1" id="completedStudies">0</div>
                <small class="text-muted">Completed</small>
              </div>
            </div>
            <div class="mt-3">
              <small class="text-muted" id="lastUpdated">Last updated: Never</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Existing Case Studies -->
  <div class="row mt-5">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-warning">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Existing Case Studies</h5>
            <div>
              <span class="badge bg-primary me-2" id="studiesCount">0 studies</span>
              <button class="btn btn-sm btn-outline-primary" onclick="loadCaseStudies()" id="refreshListBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="existingStudies" class="row g-3">
            <div class="col-12 text-center py-4">
              <i class="bi bi-cloud-download" style="font-size: 2rem;"></i>
              <p class="mt-2 text-muted">Configure the Web App URL above to load case studies</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
// Google Apps Script Web App URL
let SCRIPT_URL = '';

// Load configuration when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Load saved script URL
  const savedUrl = localStorage.getItem('vulaegisScriptUrl');
  if (savedUrl) {
    document.getElementById('scriptUrl').value = savedUrl;
    SCRIPT_URL = savedUrl;
    updateSheetLink();
    loadCaseStudies();
  }
});

// Save script URL when changed
document.getElementById('scriptUrl').addEventListener('change', function() {
  SCRIPT_URL = this.value;
  localStorage.setItem('vulaegisScriptUrl', SCRIPT_URL);
  updateSheetLink();
});

function updateSheetLink() {
  // Your Google Sheet is already set
  const sheetLink = document.getElementById('sheetLink');
  sheetLink.href = 'https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit';
}

// Function to preview case study
function previewCaseStudy() {
  const title = document.getElementById('projectTitle').value;
  const abstract = document.getElementById('projectAbstract').value;
  const status = document.getElementById('projectStatus').value;
  const driveLink = document.getElementById('googleDriveLink').value;

  if (!title || !abstract || !status || !driveLink) {
    alert('Please fill in all fields first');
    return;
  }

  const statusBadge = getStatusBadge(status);
  
  const previewHTML = `
    <div class="card h-100 border-0 shadow">
      <div class="card-body">
        ${statusBadge}
        <h5 class="card-title">${title}</h5>
        <p class="card-text">${abstract}</p>
        <a href="${driveLink}" class="btn btn-primary btn-sm" target="_blank">View Full Report</a>
      </div>
    </div>
  `;

  document.getElementById('previewArea').innerHTML = previewHTML;
}

// Function to get status badge HTML
function getStatusBadge(status) {
  const badges = {
    'ongoing': '<span class="badge bg-warning text-dark status-badge mb-2">Ongoing</span>',
    'review': '<span class="badge bg-info status-badge mb-2">Under Review</span>',
    'completed': '<span class="badge bg-success status-badge mb-2">Completed</span>'
  };
  return badges[status] || '';
}

// Function to handle form submission
document.getElementById('caseStudyForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!SCRIPT_URL) {
    alert('Please configure the Web App URL first');
    return;
  }

  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.innerHTML;
  
  // Disable button and show loading
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding to Google Sheets...';
  submitBtn.disabled = true;

  const caseStudy = {
    action: 'addCaseStudy',
    title: document.getElementById('projectTitle').value,
    abstract: document.getElementById('projectAbstract').value,
    status: document.getElementById('projectStatus').value,
    driveLink: document.getElementById('googleDriveLink').value
  };

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(caseStudy)
    });

    const result = await response.json();
    
    if (result.success) {
      // Reset form
      document.getElementById('caseStudyForm').reset();
      document.getElementById('previewArea').innerHTML = `
        <div class="text-center text-muted">
          <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
          <p class="mt-2 mb-0">Case study added successfully!</p>
          <small>Fill out the form to add another case study</small>
        </div>
      `;
      
      // Reload case studies
      await loadCaseStudies();
      
      // Show success message
      showSuccess('Case study added successfully to Google Sheets!');
    } else {
      throw new Error(result.error || 'Failed to add case study');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error adding case study: ' + error.message);
  } finally {
    // Re-enable button
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Function to load case studies from Google Sheets via Apps Script
async function loadCaseStudies() {
  if (!SCRIPT_URL) {
    document.getElementById('existingStudies').innerHTML = `
      <div class="col-12 text-center py-4">
        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
        <p class="mt-2 text-muted">Please configure the Web App URL above to load case studies</p>
      </div>
    `;
    return;
  }

  const container = document.getElementById('existingStudies');
  const refreshBtn = document.getElementById('refreshListBtn');
  const originalText = refreshBtn.innerHTML;
  
  // Show loading state
  refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Loading...';
  refreshBtn.disabled = true;
  
  container.innerHTML = `
    <div class="col-12 text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading case studies from Google Sheets...</p>
    </div>
  `;

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({action: 'getCaseStudies'})
    });

    const result = await response.json();
    
    if (result.success) {
      displayCaseStudies(result.data);
      updateStatistics(result.data);
      document.getElementById('studiesCount').textContent = `${result.data.length} studies`;
      document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
    } else {
      throw new Error(result.error || 'Failed to load case studies');
    }
  } catch (error) {
    console.error('Error loading case studies:', error);
    container.innerHTML = `
      <div class="col-12 text-center py-4">
        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
        <h5 class="mt-2">Error loading case studies</h5>
        <p class="text-muted">${error.message}</p>
        <button class="btn btn-primary btn-sm" onclick="loadCaseStudies()">Retry</button>
      </div>
    `;
  } finally {
    // Restore button state
    refreshBtn.innerHTML = originalText;
    refreshBtn.disabled = false;
  }
}

// Function to display case studies
function displayCaseStudies(caseStudies) {
  const container = document.getElementById('existingStudies');
  
  if (caseStudies.length === 0) {
    container.innerHTML = `
      <div class="col-12 text-center py-4">
        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
        <h5 class="mt-2">No case studies found</h5>
        <p class="text-muted">Add your first case study using the form above</p>
      </div>
    `;
    return;
  }

  container.innerHTML = caseStudies.map(caseStudy => `
    <div class="col-md-6 col-lg-4">
      <div class="case-study-item card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            ${getStatusBadge(caseStudy.status)}
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCaseStudy('${caseStudy.id}')" title="Delete case study">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <h6 class="card-title">${caseStudy.title}</h6>
          <p class="card-text small">${caseStudy.abstract.substring(0, 120)}${caseStudy.abstract.length > 120 ? '...' : ''}</p>
          <div class="d-flex justify-content-between align-items-center mt-auto">
            <small class="text-muted">${caseStudy.dateAdded ? new Date(caseStudy.dateAdded).toLocaleDateString() : 'Unknown date'}</small>
            <a href="${caseStudy.driveLink}" class="btn btn-primary btn-sm" target="_blank" title="View PDF">
              <i class="bi bi-file-pdf"></i> PDF
            </a>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// Function to update statistics
function updateStatistics(caseStudies) {
  const total = caseStudies.length;
  const ongoing = caseStudies.filter(cs => cs.status === 'ongoing').length;
  const completed = caseStudies.filter(cs => cs.status === 'completed').length;
  const review = caseStudies.filter(cs => cs.status === 'review').length;
  
  document.getElementById('totalStudies').textContent = total;
  document.getElementById('ongoingStudies').textContent = ongoing;
  document.getElementById('completedStudies').textContent = completed;
}

// Function to delete case study
async function deleteCaseStudy(id) {
  if (!confirm('Are you sure you want to delete this case study? This action cannot be undone.')) {
    return;
  }

  if (!SCRIPT_URL) {
    alert('Web App URL not configured');
    return;
  }

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({action: 'deleteCaseStudy', id: id})
    });

    const result = await response.json();
    
    if (result.success) {
      await loadCaseStudies();
      showSuccess('Case study deleted successfully!');
    } else {
      throw new Error(result.error || 'Failed to delete case study');
    }
  } catch (error) {
    console.error('Error deleting case study:', error);
    alert('Error deleting case study: ' + error.message);
  }
}

// Function to test connection
async function testConnection() {
  if (!SCRIPT_URL) {
    alert('Please enter the Web App URL first');
    return;
  }

  const statusDiv = document.getElementById('connectionStatus');
  const testBtn = document.getElementById('testConnectionText');
  const spinner = document.getElementById('testConnectionSpinner');
  
  testBtn.style.display = 'none';
  spinner.style.display = 'inline-block';
  statusDiv.innerHTML = '<div class="text-info"><i class="bi bi-hourglass-split"></i> Testing connection...</div>';

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({action: 'getCaseStudies'})
    });

    const result = await response.json();
    
    if (result.success) {
      statusDiv.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Connection successful! Found ${result.data.length} case studies.</span>`;
      loadCaseStudies();
    } else {
      throw new Error(result.error || 'Connection failed');
    }
  } catch (error) {
    statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> Connection failed: ${error.message}</span>`;
  } finally {
    testBtn.style.display = 'inline';
    spinner.style.display = 'none';
  }
}

// Function to show success message
function showSuccess(message) {
  const alert = document.getElementById('successAlert');
  const messageSpan = document.getElementById('successMessage');
  
  messageSpan.textContent = message;
  alert.style.display = 'block';
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    alert.style.display = 'none';
  }, 5000);
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
