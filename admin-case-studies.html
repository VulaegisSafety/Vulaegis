<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Case Studies | Vulaegis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .preview-card { border: 2px dashed #dee2e6; min-height: 200px; }
    .case-study-item { transition: all 0.3s ease; }
    .case-study-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .status-badge { font-size: 0.8rem; padding: 0.35rem 0.75rem; }
    .auto-loading { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">Vulaegis Admin</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">View Site</a></li>
        <li class="nav-item"><a class="nav-link" href="case-studies.html">Case Studies</a></li>
        <li class="nav-item"><a class="nav-link active" href="admin-case-studies.html">Admin</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-5">
  <!-- Success Alert -->
  <div id="successAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
    <span id="successMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Case Studies Admin Panel</h1>
      <p class="lead">Manage your case studies - automatically connected to Google Sheets</p>
    </div>
  </div>

  <!-- Auto-loading Status -->
  <div id="autoLoading" class="auto-loading mb-4">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2 mb-0">Loading case studies from Google Sheets...</p>
  </div>

  <div class="row">
    <!-- Add New Case Study Form -->
    <div class="col-lg-6">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Case Study</h5>
        </div>
        <div class="card-body">
          <form id="caseStudyForm">
            <div class="mb-3">
              <label for="projectTitle" class="form-label">Project Title *</label>
              <input type="text" class="form-control" id="projectTitle" required
                     placeholder="Enter project title">
            </div>
            
            <div class="mb-3">
              <label for="projectAbstract" class="form-label">Abstract/Description *</label>
              <textarea class="form-control" id="projectAbstract" rows="4" required
                        placeholder="Describe the project, objectives, and key outcomes"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="projectStatus" class="form-label">Status *</label>
              <select class="form-select" id="projectStatus" required>
                <option value="">Select Status</option>
                <option value="ongoing">Ongoing</option>
                <option value="review">Under Review</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="googleDriveLink" class="form-label">Google Drive PDF Link *</label>
              <input type="url" class="form-control" id="googleDriveLink" 
                     placeholder="https://drive.google.com/file/d/.../view" required>
              <div class="form-text">
                <small>Make sure your PDF is shared with "Anyone with the link can view"</small>
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success" id="submitBtn">
                <i class="bi bi-cloud-upload"></i> Add Case Study to Google Sheets
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="previewCaseStudy()">
                <i class="bi bi-eye"></i> Preview
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Preview Section -->
      <div class="card shadow mt-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h5>
        </div>
        <div class="card-body">
          <div id="previewArea" class="preview-card p-3 text-center text-muted">
            <i class="bi bi-card-text" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">Your case study preview will appear here</p>
            <small class="text-muted">Fill out the form and click "Preview"</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats & Actions -->
    <div class="col-lg-6">
      <!-- Statistics -->
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> Case Studies Overview</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <div class="h4 mb-1 text-primary" id="totalStudies">0</div>
              <small class="text-muted">Total Studies</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-1 text-warning" id="ongoingStudies">0</div>
              <small class="text-muted">Ongoing</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-1 text-success" id="completedStudies">0</div>
              <small class="text-muted">Completed</small>
            </div>
          </div>
          <div class="mt-3">
            <small class="text-muted" id="lastUpdated">Last updated: Loading...</small>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card shadow mt-4">
        <div class="card-header bg-warning">
          <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="loadCaseStudies()">
              <i class="bi bi-arrow-clockwise"></i> Refresh Case Studies
            </button>
            <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
               class="btn btn-outline-secondary" target="_blank">
              <i class="bi bi-google"></i> Open Google Sheet
            </a>
            <a href="https://script.google.com/home" 
               class="btn btn-outline-secondary" target="_blank">
              <i class="bi bi-code-slash"></i> Google Apps Script
            </a>
          </div>
        </div>
      </div>

      <!-- Connection Status -->
      <div class="card shadow mt-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="bi bi-wifi"></i> System Status</h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div id="connectionStatus" class="text-success">
              <i class="bi bi-check-circle-fill"></i> Connected to Google Sheets
            </div>
          </div>
          <small class="text-muted mt-2">Web App URL configured and working</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Existing Case Studies -->
  <div class="row mt-5">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-dark text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Existing Case Studies</h5>
            <div>
              <span class="badge bg-primary me-2" id="studiesCount">0 studies</span>
              <button class="btn btn-sm btn-outline-light" onclick="loadCaseStudies()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="existingStudies">
            <!-- Case studies will be loaded here automatically -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Your Web App URL - Pre-configured and ready to use
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXqcikpDsdotmulfaJPnwphSDdHeVJjZaIvazN3mcgWzj_8g8u_uJ2VT05g7ig2a9m/exec';

// Load case studies automatically when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadCaseStudies();
});

// Function to preview case study
function previewCaseStudy() {
  const title = document.getElementById('projectTitle').value;
  const abstract = document.getElementById('projectAbstract').value;
  const status = document.getElementById('projectStatus').value;
  const driveLink = document.getElementById('googleDriveLink').value;

  if (!title || !abstract || !status || !driveLink) {
    alert('Please fill in all fields first');
    return;
  }

  const statusBadge = getStatusBadge(status);
  
  const previewHTML = `
    <div class="card h-100 border-0 shadow">
      <div class="card-body">
        ${statusBadge}
        <h5 class="card-title">${title}</h5>
        <p class="card-text">${abstract}</p>
        <a href="${driveLink}" class="btn btn-primary btn-sm" target="_blank">View Full Report</a>
      </div>
    </div>
  `;

  document.getElementById('previewArea').innerHTML = previewHTML;
}

// Function to get status badge HTML
function getStatusBadge(status) {
  const badges = {
    'ongoing': '<span class="badge bg-warning text-dark status-badge mb-2">Ongoing</span>',
    'review': '<span class="badge bg-info status-badge mb-2">Under Review</span>',
    'completed': '<span class="badge bg-success status-badge mb-2">Completed</span>'
  };
  return badges[status] || '';
}

// Function to handle form submission
document.getElementById('caseStudyForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.innerHTML;
  
  // Disable button and show loading
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding to Google Sheets...';
  submitBtn.disabled = true;

  const caseStudy = {
    action: 'addCaseStudy',
    title: document.getElementById('projectTitle').value,
    abstract: document.getElementById('projectAbstract').value,
    status: document.getElementById('projectStatus').value,
    driveLink: document.getElementById('googleDriveLink').value
  };

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(caseStudy)
    });

    const result = await response.json();
    
    if (result.success) {
      // Reset form
      document.getElementById('caseStudyForm').reset();
      document.getElementById('previewArea').innerHTML = `
        <div class="text-center text-muted">
          <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
          <p class="mt-2 mb-0">Case study added successfully!</p>
          <small>Fill out the form to add another case study</small>
        </div>
      `;
      
      // Reload case studies
      await loadCaseStudies();
      
      // Show success message
      showSuccess('Case study added successfully to Google Sheets!');
    } else {
      throw new Error(result.error || 'Failed to add case study');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error adding case study: ' + error.message);
  } finally {
    // Re-enable button
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Function to load case studies from Google Sheets
async function loadCaseStudies() {
  const container = document.getElementById('existingStudies');
  const autoLoading = document.getElementById('autoLoading');
  
  // Show loading state
  autoLoading.style.display = 'block';
  container.innerHTML = '';

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({action: 'getCaseStudies'})
    });

    const result = await response.json();
    
    if (result.success) {
      displayCaseStudies(result.data);
      updateStatistics(result.data);
      document.getElementById('studiesCount').textContent = `${result.data.length} case studies`;
      document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
      
      // Hide auto-loading after successful load
      autoLoading.style.display = 'none';
    } else {
      throw new Error(result.error || 'Failed to load case studies');
    }
  } catch (error) {
    console.error('Error loading case studies:', error);
    container.innerHTML = `
      <div class="col-12 text-center py-5">
        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
        <h4 class="mt-3">Unable to Load Case Studies</h4>
        <p class="text-muted">Error: ${error.message}</p>
        <div class="mt-3">
          <button class="btn btn-primary me-2" onclick="loadCaseStudies()">Try Again</button>
          <a href="https://docs.google.com/spreadsheets/d/1lx8VbDQUmvFnSWgsKzvSV_RYv3BAJF5TJk-I-82QC3c/edit" 
             class="btn btn-outline-secondary" target="_blank">View Google Sheet</a>
        </div>
      </div>
    `;
    autoLoading.style.display = 'none';
  }
}

// Function to display case studies
function displayCaseStudies(caseStudies) {
  const container = document.getElementById('existingStudies');
  
  if (caseStudies.length === 0) {
    container.innerHTML = `
      <div class="col-12 text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
        <h4 class="mt-3">No Case Studies Yet</h4>
        <p class="text-muted">Use the form above to add your first case study</p>
      </div>
    `;
    return;
  }

  // Group by status
  const ongoing = caseStudies.filter(cs => cs.status === 'ongoing');
  const review = caseStudies.filter(cs => cs.status === 'review');
  const completed = caseStudies.filter(cs => cs.status === 'completed');

  let html = '';

  // Ongoing Studies
  if (ongoing.length > 0) {
    html += `
      <div class="mb-4">
        <h6 class="text-warning mb-3"><i class="bi bi-arrow-repeat"></i> Ongoing Projects (${ongoing.length})</h6>
        <div class="row g-3">
          ${ongoing.map(caseStudy => createCaseStudyCard(caseStudy)).join('')}
        </div>
      </div>
    `;
  }

  // Under Review Studies
  if (review.length > 0) {
    html += `
      <div class="mb-4">
        <h6 class="text-info mb-3"><i class="bi bi-clock"></i> Under Review (${review.length})</h6>
        <div class="row g-3">
          ${review.map(caseStudy => createCaseStudyCard(caseStudy)).join('')}
        </div>
      </div>
    `;
  }

  // Completed Studies
  if (completed.length > 0) {
    html += `
      <div class="mb-4">
        <h6 class="text-success mb-3"><i class="bi bi-check-circle"></i> Completed (${completed.length})</h6>
        <div class="row g-3">
          ${completed.map(caseStudy => createCaseStudyCard(caseStudy)).join('')}
        </div>
      </div>
    `;
  }

  container.innerHTML = html;
}

// Function to create individual case study card
function createCaseStudyCard(caseStudy) {
  return `
    <div class="col-md-6 col-lg-4">
      <div class="case-study-item card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            ${getStatusBadge(caseStudy.status)}
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCaseStudy('${caseStudy.id}')" title="Delete case study">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <h6 class="card-title">${caseStudy.title}</h6>
          <p class="card-text small">${caseStudy.abstract}</p>
          <div class="d-flex justify-content-between align-items-center mt-auto">
            <small class="text-muted">${caseStudy.dateAdded ? new Date(caseStudy.dateAdded).toLocaleDateString() : 'Unknown date'}</small>
            <a href="${caseStudy.driveLink}" class="btn btn-primary btn-sm" target="_blank" title="View PDF">
              <i class="bi bi-file-pdf"></i> View PDF
            </a>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Function to update statistics
function updateStatistics(caseStudies) {
  const total = caseStudies.length;
  const ongoing = caseStudies.filter(cs => cs.status === 'ongoing').length;
  const completed = caseStudies.filter(cs => cs.status === 'completed').length;
  
  document.getElementById('totalStudies').textContent = total;
  document.getElementById('ongoingStudies').textContent = ongoing;
  document.getElementById('completedStudies').textContent = completed;
}

// Function to show success message
function showSuccess(message) {
  const alert = document.getElementById('successAlert');
  const messageSpan = document.getElementById('successMessage');
  
  messageSpan.textContent = message;
  alert.style.display = 'block';
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    alert.style.display = 'none';
  }, 5000);
}

// Function to delete case study
async function deleteCaseStudy(id) {
  if (!confirm('Are you sure you want to delete this case study? This action cannot be undone.')) {
    return;
  }

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({action: 'deleteCaseStudy', id: id})
    });

    const result = await response.json();
    
    if (result.success) {
      await loadCaseStudies();
      showSuccess('Case study deleted successfully!');
    } else {
      throw new Error(result.error || 'Failed to delete case study');
    }
  } catch (error) {
    console.error('Error deleting case study:', error);
    alert('Error deleting case study: ' + error.message);
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
